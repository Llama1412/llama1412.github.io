!function(factory,window){"use strict";"function"==typeof define&&define.amd?define(["leaflet"],factory):"object"==typeof exports&&(module.exports=factory(require("leaflet"))),void 0!==window&&window.L&&(window.L.Ruler=factory(L))}(function(L){"use strict";L.Control.Ruler=L.Control.extend({options:{position:"bottomright",circleMarker:{color:"red",radius:2},lineStyle:{color:"red",dashArray:"2,6"},lengthUnit:{display:"Nautical Miles",decimal:0,factor:.539956803,label:"Distance:"},angleUnit:{display:"&deg;",decimal:0,factor:null,label:"Bearing:"}},onAdd:function(map){return this._map=map,this._container=L.DomUtil.create("div","leaflet-bar"),this._container.classList.add("leaflet-ruler"),L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._container,"click",this._toggleMeasure,this),this._choice=!1,this._defaultCursor=this._map._container.style.cursor,this._allLayers=L.layerGroup(),this._container},onRemove:function(){L.DomEvent.off(this._container,"click",this._toggleMeasure,this)},_toggleMeasure:function(){this._choice=!this._choice,this._clickedLatLong=null,this._clickedPoints=[],this._totalLength=0,this._choice?(this._map.doubleClickZoom.disable(),L.DomEvent.on(this._map._container,"keydown",this._escape,this),L.DomEvent.on(this._map._container,"dblclick",this._closePath,this),this._container.classList.add("leaflet-ruler-clicked"),this._clickCount=0,this._tempLine=L.featureGroup().addTo(this._allLayers),this._tempPoint=L.featureGroup().addTo(this._allLayers),this._pointLayer=L.featureGroup().addTo(this._allLayers),this._polylineLayer=L.featureGroup().addTo(this._allLayers),this._allLayers.addTo(this._map),this._map._container.style.cursor="crosshair",this._map.on("click",this._clicked,this),this._map.on("mousemove",this._moving,this)):(this._map.doubleClickZoom.enable(),L.DomEvent.off(this._map._container,"keydown",this._escape,this),L.DomEvent.off(this._map._container,"dblclick",this._closePath,this),this._container.classList.remove("leaflet-ruler-clicked"),this._map.removeLayer(this._allLayers),this._allLayers=L.layerGroup(),this._map._container.style.cursor=this._defaultCursor,this._map.off("click",this._clicked,this),this._map.off("mousemove",this._moving,this))},_clicked:function(e){var text;(this._clickedLatLong=e.latlng,this._clickedPoints.push(this._clickedLatLong),L.circleMarker(this._clickedLatLong,this.options.circleMarker).addTo(this._pointLayer),this._clickCount>0&&!e.latlng.equals(this._clickedPoints[this._clickedPoints.length-2]))&&(this._movingLatLong&&L.polyline([this._clickedPoints[this._clickCount-1],this._movingLatLong],this.options.lineStyle).addTo(this._polylineLayer),this._totalLength+=this._result.Distance,text=this._clickCount>1?"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._totalLength.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display:"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._result.Distance.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display,L.circleMarker(this._clickedLatLong,this.options.circleMarker).bindTooltip(text,{permanent:!0,className:"result-tooltip"}).addTo(this._pointLayer).openTooltip());this._clickCount++},_moving:function(e){var text;this._clickedLatLong&&(L.DomEvent.off(this._container,"click",this._toggleMeasure,this),this._movingLatLong=e.latlng,this._tempLine&&(this._map.removeLayer(this._tempLine),this._map.removeLayer(this._tempPoint)),this._addedLength=0,this._tempLine=L.featureGroup(),this._tempPoint=L.featureGroup(),this._tempLine.addTo(this._map),this._tempPoint.addTo(this._map),this._calculateBearingAndDistance(),this._addedLength=this._result.Distance+this._totalLength,L.polyline([this._clickedLatLong,this._movingLatLong],this.options.lineStyle).addTo(this._tempLine),text=this._clickCount>1?"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._addedLength.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display+'<br><div class="plus-length">(+'+this._result.Distance.toFixed(this.options.lengthUnit.decimal)+")</div>":"<b>"+this.options.angleUnit.label+"</b>&nbsp;"+this._result.Bearing.toFixed(this.options.angleUnit.decimal)+"&nbsp;"+this.options.angleUnit.display+"<br><b>"+this.options.lengthUnit.label+"</b>&nbsp;"+this._result.Distance.toFixed(this.options.lengthUnit.decimal)+"&nbsp;"+this.options.lengthUnit.display,L.circleMarker(this._movingLatLong,this.options.circleMarker).bindTooltip(text,{sticky:!0,offset:L.point(0,-40),className:"moving-tooltip"}).addTo(this._tempPoint).openTooltip())},_escape:function(e){27===e.keyCode&&(this._clickCount>0?this._closePath():(this._choice=!0,this._toggleMeasure()))},_calculateBearingAndDistance:function(){var f1=this._clickedLatLong.lat,l1=this._clickedLatLong.lng,f2=this._movingLatLong.lat,l2=this._movingLatLong.lng,toRadian=Math.PI/180,y=Math.sin((l2-l1)*toRadian)*Math.cos(f2*toRadian),x=Math.cos(f1*toRadian)*Math.sin(f2*toRadian)-Math.sin(f1*toRadian)*Math.cos(f2*toRadian)*Math.cos((l2-l1)*toRadian),brng=Math.atan2(y,x)*((this.options.angleUnit.factor?this.options.angleUnit.factor/2:180)/Math.PI);brng+=brng<0?this.options.angleUnit.factor?this.options.angleUnit.factor:360:0;var R=this.options.lengthUnit.factor?6371*this.options.lengthUnit.factor:6371,deltaF=(f2-f1)*toRadian,deltaL=(l2-l1)*toRadian,a=Math.sin(deltaF/2)*Math.sin(deltaF/2)+Math.cos(f1*toRadian)*Math.cos(f2*toRadian)*Math.sin(deltaL/2)*Math.sin(deltaL/2),c,distance=R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));this._result={Bearing:brng,Distance:distance}},_closePath:function(){this._map.removeLayer(this._tempLine),this._map.removeLayer(this._tempPoint),this._choice=!1,L.DomEvent.on(this._container,"click",this._toggleMeasure,this),this._toggleMeasure()}}),L.control.ruler=function(options){return new L.Control.Ruler(options)}},window);